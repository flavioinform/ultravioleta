<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CatÃ¡strofe Ultravioleta â€“ AR</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Arial}
    #hud{
      position:fixed; left:16px; top:16px; z-index:10; color:#fff;
      background:rgba(0,0,0,.7); padding:10px 12px; border-radius:10px; backdrop-filter:blur(6px);
      max-width:min(92vw,420px); font-size:14px; line-height:1.4
    }
    #hud b{color:#86a8ff}
    #legend{display:flex; gap:12px; margin-top:6px; font-size:12px; color:#ddd; flex-wrap:wrap}
    .dot{width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px}
    .btn{display:inline-block; margin-top:8px; padding:8px 10px; border-radius:8px; cursor:pointer; background:#1b1f3a; color:#fff; border:1px solid #2a3a8f}
    .small{font-size:12px; color:#b7c2ff}
    #videoBackground{
      position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1;
    }
    #startBtn{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      padding:20px 40px; font-size:18px; background:#667eea; color:#fff;
      border:none; border-radius:12px; cursor:pointer; z-index:100;
      box-shadow:0 4px 20px rgba(102,126,234,0.5);
    }
    #startBtn:hover{background:#7c8ef0}
  </style>
</head>
<body>
  <video id="videoBackground" autoplay playsinline></video>
  <button id="startBtn">ðŸŽ¥ Iniciar AR</button>
  
  <div id="hud" style="display:none">
    <b>CatÃ¡strofe Ultravioleta â€“ AR</b><br/>
    Mira el <i>cuerpo negro</i> que emite fotones y el grÃ¡fico con dos curvas:
    <div id="legend">
      <span><span class="dot" style="background:#ff3b3b"></span>Rayleigh-Jeans (clÃ¡sica)</span>
      <span><span class="dot" style="background:#3b93ff"></span>Ley de Planck (cuÃ¡ntica)</span>
    </div>
    <div class="small">Toca la pantalla o haz clic en la esfera para crear mÃ¡s fotones.</div>
    <span id="togglePhotons" class="btn">ðŸ’¡ Fotones: ON</span>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    let scene, camera, renderer, controls;
    let bodySphere, photonsGroup, emitPhotons = true;
    let graphGroup;
    let videoTexture, video;

    const startBtn = document.getElementById('startBtn');
    const hud = document.getElementById('hud');
    const videoElement = document.getElementById('videoBackground');

    startBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
        
        videoElement.srcObject = stream;
        video = videoElement;
        
        await videoElement.play();
        
        startBtn.style.display = 'none';
        hud.style.display = 'block';
        
        init();
        animate();
      } catch(err) {
        alert('Error al acceder a la cÃ¡mara: ' + err.message);
      }
    });

    function init(){
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(0, 0, 0);

      renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000, 0);
      document.body.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.minDistance = 0.5;
      controls.maxDistance = 10;

      const ambLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambLight);
      
      const p1 = new THREE.PointLight(0x667eea, 1.5, 20); 
      p1.position.set(2, 2, 1); 
      scene.add(p1);
      
      const p2 = new THREE.PointLight(0xf5576c, 1, 20); 
      p2.position.set(-2, 1, -2); 
      scene.add(p2);

      const sMat = new THREE.MeshPhysicalMaterial({
        color:0x1a1a1a, 
        roughness:0.4, 
        metalness:0.3, 
        emissive:0x330000, 
        emissiveIntensity:0.5,
        transparent: true,
        opacity: 0.95
      });
      bodySphere = new THREE.Mesh(new THREE.SphereGeometry(0.3, 48, 48), sMat);
      bodySphere.position.set(-0.6, 0, -2);
      bodySphere.userData.hot = 0;
      scene.add(bodySphere);

      photonsGroup = new THREE.Group(); 
      scene.add(photonsGroup);

      graphGroup = createGraph(); 
      graphGroup.position.set(0.7, 0, -2); 
      scene.add(graphGroup);

      renderer.domElement.addEventListener('click', onCanvasClick);
      renderer.domElement.addEventListener('touchstart', onCanvasClick);

      document.getElementById('togglePhotons').onclick = () => {
        emitPhotons = !emitPhotons;
        document.getElementById('togglePhotons').textContent = 'ðŸ’¡ Fotones: ' + (emitPhotons ? 'ON' : 'OFF');
      };

      window.addEventListener('resize', onResize);
    }

    function onResize(){
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function createGraph(){
      const group = new THREE.Group();
      const axisMat = new THREE.LineBasicMaterial({color:0x6b7cff, transparent:true, opacity:0.9});
      
      const makeAxis = (pts) => {
        const geometry = new THREE.BufferGeometry().setFromPoints(pts);
        return new THREE.Line(geometry, axisMat);
      };
      
      group.add(makeAxis([new THREE.Vector3(0,0,0), new THREE.Vector3(1.5,0,0)]));
      group.add(makeAxis([new THREE.Vector3(0,0,0), new THREE.Vector3(0,1.0,0)]));

      const rjMat = new THREE.LineBasicMaterial({ color: 0xff3b3b, linewidth: 2, transparent:true, opacity:0.95 });
      const rjPts = [];
      for(let i=1; i<=150; i++){ 
        const x = i/100; 
        const y = Math.min(1.0, 0.015/Math.pow(x, 1.7)); 
        rjPts.push(new THREE.Vector3(x, y, 0)); 
      }
      group.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(rjPts), rjMat));

      const plMat = new THREE.LineBasicMaterial({ color: 0x3b93ff, linewidth: 2, transparent:true, opacity:0.95 });
      const plPts = [];
      for(let i=1; i<=150; i++){ 
        const x = i/100; 
        const c2 = 2.2; 
        const val = (1/Math.pow(x, 2)) / (Math.exp(c2/x) - 1); 
        const y = THREE.MathUtils.clamp(val * 0.6, 0, 0.95); 
        plPts.push(new THREE.Vector3(x, y, 0.001)); 
      }
      group.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(plPts), plMat));

      const gridMat = new THREE.LineBasicMaterial({color:0x4466ff, transparent:true, opacity:0.3});
      const gridSize = 1.5;
      const divisions = 10;
      
      for(let i = 0; i <= divisions; i++){
        const pos = (i / divisions) * gridSize;
        group.add(makeAxis([new THREE.Vector3(pos, 0, 0), new THREE.Vector3(pos, 1, 0)]));
        group.add(makeAxis([new THREE.Vector3(0, pos*0.67, 0), new THREE.Vector3(gridSize, pos*0.67, 0)]));
      }
      
      return group;
    }

    function animate(){ 
      requestAnimationFrame(animate);
      step();
    }

    function step(){
      if (emitPhotons && Math.random() < 0.5) spawnPhoton();
      
      for (let i = photonsGroup.children.length - 1; i >= 0; i--){
        const p = photonsGroup.children[i];
        p.position.add(p.userData.vel);
        p.material.opacity *= 0.985;
        p.scale.multiplyScalar(1.01);
        
        if (p.material.opacity < 0.02 || p.position.length() > 20){
          photonsGroup.remove(p); 
          p.geometry.dispose(); 
          p.material.dispose();
        }
      }
      
      graphGroup.rotation.y = Math.sin(Date.now() * 0.0003) * 0.15;
      bodySphere.rotation.y += 0.005;
      
      controls.update();
      renderer.render(scene, camera);
    }

    function spawnPhoton(){
      const g = new THREE.SphereGeometry(0.012, 12, 12);
      const m = new THREE.MeshBasicMaterial({
        color: 0xffee88, 
        transparent: true, 
        opacity: 0.95
      });
      const p = new THREE.Mesh(g, m);
      
      const n = new THREE.Vector3(
        Math.random() - 0.5,
        Math.random() - 0.5,
        Math.random() - 0.5
      ).normalize();
      
      p.position.copy(bodySphere.position).add(n.multiplyScalar(0.32));
      
      const v = p.position.clone().sub(bodySphere.position).normalize();
      p.userData.vel = v.multiplyScalar(0.03 + Math.random() * 0.03)
        .add(new THREE.Vector3(0, 0.015 * Math.random(), 0));
      
      photonsGroup.add(p);
    }

    function burstPhotons(){
      bodySphere.userData.hot = Math.min(1, bodySphere.userData.hot + 0.6);
      for (let i = 0; i < 50; i++) spawnPhoton();
    }

    function onCanvasClick(event){
      event.preventDefault();
      
      let clientX, clientY;
      if(event.touches){
        clientX = event.touches[0].clientX;
        clientY = event.touches[0].clientY;
      } else {
        clientX = event.clientX;
        clientY = event.clientY;
      }
      
      const mouse = new THREE.Vector2(
        (clientX / window.innerWidth) * 2 - 1,
        -(clientY / window.innerHeight) * 2 + 1
      );
      
      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(mouse, camera);
      
      const intersects = raycaster.intersectObject(bodySphere);
      if (intersects.length > 0){
        burstPhotons();
      }
    }
  </script>
</body>
</html>